---
title: "Deer Creek"
author: "[Sadie Gill](mailto:sgill@flowwest.com), [Mark Tompkins](mailto:mtompkins@flowwest.com)" 
date: "June 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, out.width = '100%')
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(usethis.quiet = TRUE)
library(tidyverse)
library(readxl)
library(DSMhabitat)
```   


```{r}
source('data-raw/watershed/floodplain_utils.R')
```

```{r}
# the rearing lengths need to scaled, based on the model length and the actual rearing
# the sr spawning needs to be approximated using the regional method

deer_habitat_lens <- read_xlsx("data-raw/watershed/CVPIA_FloodplainAreas.xlsx") %>% 
  filter(watershed == "Deer Creek")

raw_data <- read_csv("data-raw/watershed/deer/data/existing-suitability-deer-creek-2021-03-24.csv")

sr_scale <- (as.numeric(deer_habitat_lens$SR_rearing_length_mi) - deer_habitat_lens$FR_length_modeled_mi) / deer_habitat_lens$FR_length_modeled_mi

st_scale <- (as.numeric(deer_habitat_lens$ST_rearing_length_mi) - deer_habitat_lens$FR_length_modeled_mi) / deer_habitat_lens$FR_length_modeled_mi

# get all data in appropriate names
deer_creek_habitat <- raw_data %>% 
  filter(species %in% c("fall", "late-fall", "spring", "steelhead"), 
         life_stage %in% c("adult", "juvenile", "spawning")) %>%
  mutate(suitable_acres = ifelse(suitable_acres < 0, NA_real_, suitable_acres)) %>% 
  transmute(
    flow_cfs = flow, 
    sqm = acres_to_square_meters(suitable_acres), 
    suitable_acres,
    species = case_when(
      species == "fall" ~ "fr", 
      species == "spring" ~ "sr", 
      species == "late-fall" ~ "lfr", 
      species == "steelhead" ~ "st", # double check
      TRUE ~ NA_character_
    ),
    life_stage = case_when(
      life_stage == "adult" ~ "adult", 
      life_stage == "juvenile" ~ "juv", 
      life_stage == "spawning" ~ "spawn"
    ), 
    habitat_type, 
    watershed = "Deer Creek"
  )
```

## Instream Spawning and Rearing Habitat
**Data Source:** [FlowWest 2021](https://cvpiahabitat-r-package.s3.us-west-2.amazonaws.com/cvpia-sit-model-inputs/DeerCreek_2Dmodel_FlowWest_Final.pdf){target="_blank"}

A flow to suitable area relationship was modeled using 2-dimensional hydraulic model called HEC-RAS for the instream spawning habitat of Fall Run Chinook Salmon, Late-Fall Run Chinook Salmon and the instream rearing habitat of Fall Run Chinook Salmon, Late-Fall Run Chinook Salmon, Spring Run Chinook Salmon, and Steelhead.

Spring Run Chinook and Steelhead spawning habitat were [calculated with a relationship between flow and mean weighted usable area from watersheds in the region with modeled habitat](http://cvpia-habitat-docs-markdown.s3-website-us-west-2.amazonaws.com/watershed/Regional_Approximation.html){target="_blank"}

<!-- # TODO find where regional approx for spring run and steelhead need to be modified -->
### Spawning and Rearing Data 
```{r}
# instream
# we need to scale sr_juv and st_juv only
# sr_spawn needs to be regional approximated
deer_creek_instream <-
  deer_creek_habitat %>% 
  filter(habitat_type == "instream") %>% 
  transmute(
    flow_cfs, 
    col_to_spread = sprintf("%s_%s_sqm", toupper(species), life_stage), 
    sqm, 
    watershed
  ) %>% 
    spread(col_to_spread, sqm) %>% 
  transmute(
    flow_cfs, 
    FR_spawn_sqm, 
    FR_juv_sqm,
    LFR_spawn_sqm, 
    LFR_juv_sqm,
    SR_juv_sqm = (SR_juv_sqm + ((sr_scale*SR_juv_sqm)*.1)),
    ST_juv_sqm = (ST_juv_sqm + ((st_scale*ST_juv_sqm)*.1)),
    watershed
  )

knitr::kable(align = 'c', head(deer_creek_instream, 5), 
             caption = "Header Descriptions: flow_cfs = flow in cubic feet per second,
             FR_spawn_sqm = Fall Run Chinook Spawning Area (square meters),
             FR_juv_sqm = Fall Run Chinook Juvenile Area (square meters), 
             LFR_spawn_sqm = Late-Fall Run Chinook Spawning Area (square meters), 
             LFR_juv_sqm = Late-Fall Run Chinook Juvenile Area (square meters), 
             SR_juv_sqm = Spring Run Chinook Juvenile Area (square meters),
             ST_juv_sqm = Steelhead Juvenile Area (square meters),
             watershed = section of stream modeled for CVPIA SDM")

usethis::use_data(deer_creek_instream, overwrite = TRUE)
```
*... with `r nrow(deer_creek_instream) - 5` more rows*


### Spawning Habitat Area 
The following plot shows the suitable spawning habitat in square meters for Fall Run and 
Late-Fall Run Chinook. 
```{r}
deer_creek_instream %>% 
  select(flow_cfs, `Fall and Late-Fall Run Chinook` = FR_spawn_sqm) %>% 
  gather(species, acres, -flow_cfs) %>% 
  ggplot(aes(flow_cfs,acres/4046.86, color = species)) + 
  geom_line() + 
  labs(x = 'Flow (cfs)', y = 'Suitable Habitat (acres)', color = NULL) + 
  theme_minimal() + 
  scale_color_brewer(palette = 'Dark2') +
  theme(legend.justification = c(1, 0), legend.position = c(.97, .7))
```

### Rearing Habitat Area 
The following plot shows the suitable rearing habitat in square meters for Fall Run Chinook, 
Late-Fall Run Chinook, Spring Run Chinook and Steelhead. 
```{r}
deer_creek_instream %>% 
  select(flow_cfs, `Fall and Late-Fall Run Chinook` = FR_juv_sqm, 
         `Spring Run Chinook and Steelhead` = SR_juv_sqm) %>% 
  gather(species, acres, -flow_cfs) %>% 
  ggplot(aes(flow_cfs, acres/4046.86, color = species)) + 
  geom_line() + 
  labs(x = 'Flow (cfs)', y = "Suitable Habitat (acres)", color = NULL) + 
  theme_minimal() + 
  scale_color_brewer(palette = 'Dark2') +
  theme(legend.justification = c(1, 0), legend.position = c(.97, .7))
```

## Floodplain Rearing Habitat 

**Data Source:** [Calcuated using a flow to area relationship modeled using HEC-RAS (FlowWest 2021)](https://cvpiahabitat-r-package.s3.us-west-2.amazonaws.com/cvpia-sit-model-inputs/DeerCreek_2Dmodel_FlowWest_Final.pdf){target="_blank"}

# TODO update documentation details
fall run and late-fall run
`r print_model_details('Deer Creek', 'fr')`
<!-- `r print_model_details('Deer Creek', 'lfr')` -->
<!-- `r print_model_details('Deer Creek', 'sr')` -->
<!-- `r print_model_details('Deer Creek', 'st')` -->

## Floodplain Data    
The areas represent total suitable rearing area in acres.

```{r}
deer_creek_floodplain <- 
  deer_creek_habitat %>% 
  filter(habitat_type == "floodplain", life_stage == "juv") %>% 
  transmute(
    flow_cfs, 
    col_to_spread = sprintf("%s_floodplain_acres", toupper(species)), 
    suitable_acres,
    watershed
  ) %>% 
  spread(col_to_spread, suitable_acres) %>% 
  transmute(
    flow_cfs, 
    FR_floodplain_acres, 
    LFR_floodplain_acres, 
    SR_floodplain_acres = (SR_floodplain_acres + (sr_scale*SR_floodplain_acres)*.1),
    ST_floodplain_acres = (ST_floodplain_acres + (st_scale*ST_floodplain_acres)*.1),
    watershed
  ) %>% 
  relocate(watershed, .after = ST_floodplain_acres)

knitr::kable(align = 'c', head(deer_creek_floodplain, 5), 
             caption = "Header Descriptions: flow_cfs = flow in cubic feet per second,
             FR_floodplain_acres = Fall Run Chinook floodplain acres, SR_floodplain_acres 
             = Spring Run Chinook floodplain acres, ST_floodplain_acres = 
             Steelhead floodplain acres, 
             watershed = section of stream modeled for CVPIA SDM")

usethis::use_data(deer_creek_floodplain, overwrite = TRUE)
```

*... with `r nrow(deer_creek_floodplain) - 5` more rows*

## Floodplain Plot
```{r}
deer_creek_floodplain %>% 
  select(`Fall and Late-Fall Run Chinook` = FR_floodplain_acres, 
         `Spring Run Chinook and Steelhead` = SR_floodplain_acres, flow_cfs) %>%
  gather(species, acres, -flow_cfs) %>% 
  ggplot(aes(flow_cfs, acres, color = species)) +
  geom_line() +
  theme_minimal() +
  scale_color_brewer(palette = 'Dark2') +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Area (acres)') +
  theme(legend.justification = c(1,0), legend.position = c(1,.1))
```
