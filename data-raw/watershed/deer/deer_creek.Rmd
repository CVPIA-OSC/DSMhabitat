---
title: "Deer Creek"
author: "[Sadie Gill](mailto:sgill@flowwest.com), [Mark Tompkins](mailto:mtompkins@flowwest.com)" 
date: "July 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, out.width = '100%')
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(usethis.quiet = TRUE)
library(tidyverse)
library(readxl)
library(DSMhabitat)
```   


```{r}
source('data-raw/watershed/floodplain_utils.R')
```

```{r}
# the rearing lenghts need to scaled, based on the model length and the actual rearing
# the sr spawning needs to be approximated using the regional method

deer_habitat_lens <- read_xlsx("data-raw/watershed/CVPIA_FloodplainAreas.xlsx") %>% 
  filter(watershed == "Deer Creek")

raw_data <- read_csv("data-raw/watershed/deer/data/existing-suitability-deer-creek-2021-03-24.csv")

hec_ras_modeling_extend <- 12 # miles
habitat_extent <- 47.92 
sr_scale <- (habitat_extent-hec_ras_modeling_extend)/hec_ras_modeling_extend
st_scale <- (habitat_extent-hec_ras_modeling_extend)/hec_ras_modeling_extend

# get all data in appropriate names
deer_creek_habitat <- raw_data %>% 
  filter(species %in% c("fall", "late-fall", "spring", "steelhead"), 
         life_stage %in% c("adult", "juvenile", "spawning")) %>%
  mutate(suitable_acres = ifelse(suitable_acres < 0, NA_real_, suitable_acres)) %>% 
  transmute(
    flow_cfs = flow, 
    sqm = acres_to_square_meters(suitable_acres), 
    suitable_acres,
    species = case_when(
      species == "fall" ~ "fr", 
      species == "spring" ~ "sr", 
      species == "late-fall" ~ "lfr", 
      species == "steelhead" ~ "st", # double check
      TRUE ~ NA_character_
    ),
    life_stage = case_when(
      life_stage == "adult" ~ "adult", 
      life_stage == "juvenile" ~ "juv", 
      life_stage == "spawning" ~ "spawn"
    ), 
    habitat_type, 
    watershed = "Deer Creek"
  )

# instream
# we need to scale sr_juv and st_juv only
# sr_spawn needs to be regional approximated
deer_creek_instream <-
  deer_creek_habitat %>% 
  filter(habitat_type == "instream") %>% 
  transmute(
    flow_cfs, 
    col_to_spread = sprintf("%s_%s_hsi", toupper(species), life_stage), 
    sqm, 
    watershed
  ) %>% 
    spread(col_to_spread, sqm) %>% 
  transmute(
    flow_cfs, 
    FR_spawn_hsi, 
    FR_juv_hsi,
    LFR_spawn_hsi, 
    LFR_juv_hsi,
    SR_juv_hsi = (SR_juv_hsi + (sr_scale*SR_juv_hsi)*.1),
    ST_juv_hsi = (ST_juv_hsi + (st_scale*ST_juv_hsi)*.1),
    watershed
  )

usethis::use_data(deer_creek_instream, overwrite = TRUE)

# floodplain
deer_creek_floodplain <- 
  deer_creek_habitat %>% 
  filter(habitat_type == "floodplain", life_stage == "juv") %>% 
  transmute(
    flow_cfs, 
    col_to_spread = sprintf("%s_floodplain_acres", toupper(species)), 
    suitable_acres,
    watershed
  ) %>% 
  spread(col_to_spread, suitable_acres) %>% 
  transmute(
    flow_cfs, 
    FR_floodplain_acres, 
    LFR_floodplain_acres, 
    SR_floodplain_acres = (SR_floodplain_acres + (sr_scale*SR_floodplain_acres)*.1),
    ST_floodplain_acres = (ST_floodplain_acres + (st_scale*ST_floodplain_acres)*.1),
    watershed
  ) %>% 
  relocate(watershed, .after = ST_floodplain_acres)

usethis::use_data(deer_creek_floodplain, overwrite = TRUE)
```

## Instream Spawning and Rearing Habitat
**Data Source:** [Calcuated using a flow to area relationship modeled using HEC-RAS (FlowWest 2021)](#){target="_blank"}

### Spawning HSI 

The following plot shows suitable habitat in square meters for Fall Run, Spring Run and 
Late-Fall Run Chinook.

```{r}
deer_creek_instream %>% 
  select(flow_cfs, FR_spawn_hsi, LFR_spawn_hsi, LFR_spawn_hsi) %>% 
  gather(species, suitable_habitat, -flow_cfs) %>% 
  mutate(
    species = case_when(
      species == "FR_spawn_hsi" ~ "Fall Run Chinook",
      species == "LFR_spawn_hsi" ~ "Late-Fall Run Chinook",
      species == "SR_spawn_hsi" ~ "Spring Run Chinook",
      TRUE ~ NA_character_
    )
  ) %>% 
  ggplot(aes(flow_cfs, suitable_habitat/4046.86, color = species)) + 
  geom_line() + 
  labs(x = 'Flow (cfs)', y = 'Suitable Habitat (acres)', color = NULL) + 
  theme_minimal() + 
  scale_color_brewer(palette = 'Dark2') +
  theme(legend.justification = c(1, 0), legend.position = c(.97, .7))
```

### Rearing HSI 

```{r}
deer_creek_instream %>% 
  select(flow_cfs, FR_juv_hsi, LFR_juv_hsi, ST_juv_hsi) %>% 
  gather(species, suitable_habitat, -flow_cfs) %>% 
  mutate(
    species = case_when(
      species == "FR_juv_hsi" ~ "Fall Run Chinook",
      species == "LFR_juv_hsi" ~ "Late-Fall Run Chinook",
      species == "ST_juv_hsi" ~ "Spring Run Chinook",
      TRUE ~ NA_character_
    )
  ) %>% 
  ggplot(aes(flow_cfs, suitable_habitat/4046.86, color = species)) + 
  geom_line() + 
  labs(x = 'Flow (cfs)', y = "Suitable Habitat (acres)", color = NULL) + 
  theme_minimal() + 
  scale_color_brewer(palette = 'Dark2') +
  theme(legend.justification = c(1, 0), legend.position = c(.97, .7))
```

## Floodplain Rearing Habitat 
**Data Source:** [Calcuated using a flow to area relationship modeled using HEC-RAS (FlowWest 2021)](#){target="_blank"}

### Fall Run
`r print_model_details('Deer Creek', 'fr')`

### Spring Run and Steelhead
`r print_model_details('Deer Creek', 'sr')`

## Floodplain Data    
The areas represent total inundated area in acres.

```{r}
knitr::kable(align = 'c', head(deer_creek_floodplain, 5), 
             caption = "Header Descriptions: flow_cfs = flow in cubic feet per second,
             FR_floodplain_acres = Fall Run Chinook floodplain acres, SR_floodplain_acres 
             = Spring Run Chinook floodplain acres, ST_floodplain_acres = 
             Steelhead floodplain acres, 
             watershed = section of stream modeled for CVPIA SDM")

usethis::use_data(deer_creek_floodplain, overwrite = TRUE)
```

*... with `r nrow(deer_creek_floodplain) - 5` more rows*

## Floodplain Plot
```{r}
deer_creek_floodplain %>% 
  select(FR_floodplain_acres, SR_floodplain_acres, watershed, flow_cfs) %>%
  rename(`Fall Run Chinook` = FR_floodplain_acres, `Spring Run Chinook and Steelhead` = SR_floodplain_acres) %>% 
  gather(Species, acres, -flow_cfs, -watershed) %>% 
  ggplot(aes(flow_cfs, acres, color = Species)) +
  geom_line() +
  theme_minimal() +
  scale_color_brewer(palette = 'Dark2') +
  labs(x = 'Flow (cfs)', y = 'Total Inundated Acres') +
  theme(legend.justification = c(1,0), legend.position = c(1,.1))
```
